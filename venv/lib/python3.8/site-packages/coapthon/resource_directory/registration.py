from coapthon.resources.resource import Resource

from .databaseManager import DatabaseManager
from coapthon import defines
import rdIroha
import SemanticOperations
import random

__author__ = 'Carmelo Aparo'


class Registration(Resource):
    """
    Implementation of the registration resource.
    """
    def __init__(self, name="rd", database=defines.MONGO_DATABASE, Fuseki_port="3030"):
        """
        Initialize a resource for registration management.
        :param name: the name of the resource.
        """
        super(Registration, self).__init__(name, coap_server=None, visible=True, observable=False)
        self.resource_type = "core.rd"
        self.content_type = "application/link-format"
        self.database = database
        self.Fuseki_port = Fuseki_port

    def render_GET_advanced(self, request, response):
        """
        Method GET to read endpoint links.
        :param request: the request of the GET message.
        :param response: the response to the GET request.
        :return: the response to the GET request.
        """
        if request.uri_path == 'rd':
            raise NotImplementedError
        if (request.accept != defines.Content_types["application/link-format"]) and (request.accept is not None):
            response.code = defines.Codes.NOT_ACCEPTABLE.number
            return self, response
        res = "res=" + request.uri_path
        db = DatabaseManager()
        result = db.search(res, "res")
        if type(result) is int:
            response.code = result
        else:
            response.code = defines.Codes.CONTENT.number
            response.payload = result
            response.content_type = defines.Content_types["application/link-format"]
        return self, response

    def render_POST_advanced(self, request, response):
        """
        Method POST to register and update an endpoint.
        :param request: the request of the POST message.
        :param response: the response to the POST message.
        :return: the response to the POST message.
        """
        # todo : insert iroha registration code

        db = DatabaseManager(database=self.database)
        if request.uri_path == 'rd':
            if request.content_type != defines.Content_types["application/link-format"]:
                response.code = defines.Codes.BAD_REQUEST.number
                return self, response
            uri_query = request.uri_query
            if "con=" not in uri_query:
                uri_query += "&con=coap://" + request.source[0] + ":" + str(request.source[1])
            # result = db.insert(uri_query, request.payload)
            """
                Cancel mongodb operation            
            """
            result = "rd/46"
            uri_query_variables = db.parse_uri_query(request.uri_query)
            # account_name = uri_query_variables['account']
            # rd_iroha = rdIroha.RdIroha(account_name)
            # with_smart_contract = True
            # print('hash' + str(hash('Resource')))
            # rd_iroha.addResourceToAccountDetail('Resource')
            # bc_result = rd_iroha.register(uri_query, request.payload, with_smart_contract)
            """
                simulate semantic ressource insertion            
            """
            semchain = SemanticOperations.SemanticOperations(rdf_database= 'drd'+self.Fuseki_port[-1],server_port=self.Fuseki_port)
            resource_number = uri_query_variables['resnbr']
            data = []
            for x in range(0, int(resource_number)):
                ifs = ['sensor', 'actuator', 'trigger', 'device']
                if_name = random.choice(ifs)
                print(if_name)
                data.append(['Device', 'rt', if_name])

            semchain.insertData(data)
            if type(result) is int:
                response.code = result
            else:
                response.location_path = result
                response.code = defines.Codes.CREATED.number
        else:
            response.code = db.update(request.uri_path, request.uri_query)
        return self, response

    def render_DELETE_advanced(self, request, response):
        """
        Method DELETE to delete an endpoint registration.
        :param request: the request of the DELETE message.
        :param response: the response to the DELETE message.
        :return: the response to the DELETE message.
        """
        if request.uri_path == 'rd':
            raise NotImplementedError
        db = DatabaseManager()
        response.code = db.delete(request.uri_path)
        return False, response
